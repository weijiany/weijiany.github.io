<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://weijiany.github.io/kubernetes/auth/0-kube-rbac-proxy/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>kube-rbac-proxy - 🐶🥚 碎碎念</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "kube-rbac-proxy";
        var mkdocs_page_input_path = "kubernetes/auth/0-kube-rbac-proxy.md";
        var mkdocs_page_url = "/kubernetes/auth/0-kube-rbac-proxy/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> 🐶🥚 碎碎念
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Hello World</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Aws</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="#">Eks</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../aws/eks/0-vpc-cni-%E7%BD%91%E7%BB%9C%E7%AD%96%E7%95%A5/">AWS VPC CNI 网络策略</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Iam</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../aws/iam/0-%E8%AE%A4%E8%AF%86%20sso/">认识 AWS SSO</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Container</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../container/0-build-cross-image/">Build cross images</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Iptables</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../iptables/0-%E8%AE%A4%E8%AF%86%20iptables/">认识 Linux iptables</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Kubernetes</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Auth</a>
    <ul class="current">
                <li class="toctree-l2 current"><a class="reference internal current" href="./">kube-rbac-proxy</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Cni</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../cni/0-%E8%AE%A4%E8%AF%86%20cni/">认识 kubernetes CNI</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">Network</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../cni/network/0-netns%20%E4%BA%92%E8%BF%9E/">network namespace 互连</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Hpa</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../hpa/0-hpa-%E8%AF%86%E5%88%AB-external-metric/">HPA 识别 external metric</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Loadbalancer</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../loadbalancer/0-local-LoadBalancer-metallb/">Local LoadBalancer metallb</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">🐶🥚 碎碎念</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Kubernetes</li>
          <li class="breadcrumb-item">Auth</li>
      <li class="breadcrumb-item active">kube-rbac-proxy</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="kube-rbac-proxy">kube-rbac-proxy</h1>
<p>今天在过 OTEL-operator 的时候发现，OTEL-operator 使用了一个名为：<a href="https://github.com/open-telemetry/opentelemetry-helm-charts/blob/ddda95b32ec4f87909e4de312f13140593018b09/charts/opentelemetry-operator/values.yaml#L222-L226">kube-rbac-proxy 的 sidecar.</a></p>
<p>于是花时间了解一下什么是 <a href="https://github.com/brancz/kube-rbac-proxy/">kube-rbac-proxy. 🥳</a>。</p>
<pre><code class="language-python">print(&quot;Hello, MkDocs!&quot;)

## Introduction

kube-rbac-proxy 是一个基于 K8S RBAC 来做 auth 并且防护后面代理的服务，暂时还处于 v0 阶段，还没有正式 release 只不过可以浅尝一下。OTEL-operator 可以通过 enable kube-rbac-proxy 来对 `/metrics` 接口做 auth，以便于只允许 prometheus 带着固定的 service-account token 才可以访问。

## Precondition

在介绍 kube-rbac-proxy 之前，需要提一下 `kubectl auth can-i` 这个命令。这个命令主要是用来查看当前用户对于当前 cluster (kube-config) 的资源都有什么权限

</code></pre>
<p>Resources                                        Non-Resource URLs        Resource Names     Verbs
pods/exec                                        []                       []                 [<em>]
pods/portforward                                 []                       []                 [</em>]
pods/eviction                                    []                       []                 [create]
selfsubjectreviews.authentication.k8s.io         []                       []                 [create]
selfsubjectaccessreviews.authorization.k8s.io    []                       []                 [create]
selfsubjectrulesreviews.authorization.k8s.io     []                       []                 [create]
...</p>
<pre><code>
类似于这种输出，可以很直观的看到 resource 与 verb 之间的关系。那么 k8s 是怎么实现这套机制的呢？在 k8s 官方文档中有一章节讲 [Checking API access](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#checking-api-access) 提到：可以使用 SelfSubjectAccessReview 来检查当前用户对于哪些资源的权限。

&gt; SelfSubjectAccessReview is part of the authorization.k8s.io API group, which exposes the API server authorization to external services. Other resources in this group include:
&gt;
&gt; **SubjectAccessReview**
&gt; Access review for any user, not only the current one. Useful for delegating authorization decisions to the API server. For example, the kubelet and extension API servers use this to determine user access to their own APIs.
&gt; **LocalSubjectAccessReview**
&gt; Like SubjectAccessReview but restricted to a specific namespace.
&gt; **SelfSubjectRulesReview**
&gt; A review which returns the set of actions a user can perform within a namespace. Useful for users to quickly summarize their own access, or for UIs to hide/show actions.

我本地集群使用 [orbstack](https://orbstack.dev/) 启动的，可以使用 `SubjectAccessReview` 来检查 `system:kube-scheduler` 对于 default namesapce 下的 pod 有没有 Get 权限

```shell
create -f - -o yaml &lt;&lt; EOF
apiVersion: authorization.k8s.io/v1
kind: SubjectAccessReview
spec:
  user: &quot;system:kube-scheduler&quot;
  resourceAttributes:
    namespace: &quot;default&quot;
    verb: &quot;get&quot;
    resource: &quot;pods&quot;
EOF

# Output
apiVersion: authorization.k8s.io/v1
kind: SubjectAccessReview
metadata:
  creationTimestamp: null
spec:
  resourceAttributes:
    namespace: default
    resource: pods
    verb: get
  user: system:kube-scheduler
status:
  allowed: true
  reason: 'RBAC: allowed by ClusterRoleBinding &quot;system:kube-scheduler&quot; of ClusterRole
    &quot;system:kube-scheduler&quot; to User &quot;system:kube-scheduler&quot;'
</code></pre>
<h2 id="how">How</h2>
<p>有了 <code>SubjectAccessReview</code> 就可以验证当前用户权限，但是目前来看都是对于 K8S 内置的资源，但是像 OTEL-operator 实际上是对 <code>/metrics</code> 接口做 auth，在 K8S 中怎么实现呢？</p>
<p>K8S 已经实现可以对 ClusterRole 添加 <code>nonResourceURLs</code> 字段，以便于给 ClusterRole 对应接口的权限，基于上述 <code>/metrics</code> 接口的 ClusterRole yaml:</p>
<pre><code class="language-yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: allow-access-otel-operator
rules:
- nonResourceURLs: [&quot;/metrics&quot;]
  verbs: [&quot;get&quot;]
</code></pre>
<p>再把 allow-access-otel-operator ClusterRole 绑定到 ServiceAccount 上以后，pod 在使用 ServiceAccount 会自动在 <code>/var/run/secrets/kubernetes.io/serviceaccount</code> 挂载 ServiceAccount token，可以通过在请求接口的时候带着：<code>Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)</code> header 这样 auth 请求就能通过。</p>
<h2 id="example">Example</h2>
<details>
<summary>kube-rbac-proxy -> nginx deployment yaml</summary>


<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      serviceAccountName: nginx-service-account
      containers:
      - name: nginx
        image: nginx:mainline-alpine3.22
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
      - name: kube-rbac-proxy
        args:
        - --secure-listen-address=0.0.0.0:8443
        - --upstream=http://127.0.0.1:80/
        - --v=0
        image: quay.io/brancz/kube-rbac-proxy:v0.19.1
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8443
          name: https
          protocol: TCP
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
  labels:
    app: nginx
spec:
  type: ClusterIP
  ports:
  - name: https
    port: 8443
    targetPort: https
    protocol: TCP
  selector:
    app: nginx
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nginx-service-account
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: nginx-rbac-proxy-role
rules:
# kube-rbac-proxy 需要这些权限做认证
- apiGroups: [&quot;authentication.k8s.io&quot;]
  resources: [&quot;tokenreviews&quot;]
  verbs: [&quot;create&quot;]
- apiGroups: [&quot;authorization.k8s.io&quot;]
  resources: [&quot;subjectaccessreviews&quot;]
  verbs: [&quot;create&quot;]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: nginx-rbac-proxy-binding
subjects:
- kind: ServiceAccount
  name: nginx-service-account
  namespace: default
roleRef:
  kind: ClusterRole
  name: nginx-rbac-proxy-role
  apiGroup: rbac.authorization.k8s.io
</code></pre>

</details>
<p><br></p>
<details>
<summary>another pod to access kube-rbac-proxy</summary>


<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: curl
spec:
  serviceAccountName: test-service-account
  containers:
  - name: curl
    image: alpine/curl:8.14.1
    command: [&quot;sleep&quot;, &quot;3600&quot;]
    ports:
    - containerPort: 80
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: test-service-account
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: nginx-pod-reader
rules:
- nonResourceURLs: [&quot;/&quot;]
  verbs: [&quot;get&quot;]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: nginx-pod-reader-binding
  labels:
    app: test
subjects:
- kind: ServiceAccount
  name: test-service-account
  namespace: default
roleRef:
  kind: ClusterRole
  name: nginx-pod-reader
  apiGroup: rbac.authorization.k8s.io
</code></pre>


测试：

<pre><code class="language-yaml">kubectl  exec -it pods/test-pod -- sh

# 会返回 nginx 首页
curl -H 'Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)' https://nginx-service:8443/ -k
</code></pre>

</details>
<p><br></p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../../iptables/0-%E8%AE%A4%E8%AF%86%20iptables/" class="btn btn-neutral float-left" title="认识 Linux iptables"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../cni/0-%E8%AE%A4%E8%AF%86%20cni/" class="btn btn-neutral float-right" title="认识 kubernetes CNI">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../../../iptables/0-%E8%AE%A4%E8%AF%86%20iptables/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../cni/0-%E8%AE%A4%E8%AF%86%20cni/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
