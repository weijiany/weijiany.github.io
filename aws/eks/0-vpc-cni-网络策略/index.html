<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://weijiany.github.io/aws/eks/0-vpc-cni-%E7%BD%91%E7%BB%9C%E7%AD%96%E7%95%A5/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>AWS VPC CNI ç½‘ç»œç­–ç•¥ - ğŸ¶ğŸ¥š ç¢ç¢å¿µ</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "AWS VPC CNI \u7f51\u7edc\u7b56\u7565";
        var mkdocs_page_input_path = "aws/eks/0-vpc-cni-\u7f51\u7edc\u7b56\u7565.md";
        var mkdocs_page_url = "/aws/eks/0-vpc-cni-%E7%BD%91%E7%BB%9C%E7%AD%96%E7%95%A5/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> ğŸ¶ğŸ¥š ç¢ç¢å¿µ
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Hello World</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Aws</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Eks</a>
    <ul class="current">
                <li class="toctree-l2 current"><a class="reference internal current" href="./">AWS VPC CNI ç½‘ç»œç­–ç•¥</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Iam</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../iam/0-%E8%AE%A4%E8%AF%86%20sso/">è®¤è¯† AWS SSO</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Container</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../container/0-build-cross-image/">Build cross images</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Iptables</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../iptables/0-%E8%AE%A4%E8%AF%86%20iptables/">è®¤è¯† Linux iptables</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Kubernetes</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="#">Auth</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../kubernetes/auth/0-kube-rbac-proxy/">kube-rbac-proxy</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Cni</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../kubernetes/cni/0-%E8%AE%A4%E8%AF%86%20cni/">è®¤è¯† kubernetes CNI</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">Network</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../kubernetes/cni/network/0-netns%20%E4%BA%92%E8%BF%9E/">network namespace äº’è¿</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Hpa</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../kubernetes/hpa/0-hpa-%E8%AF%86%E5%88%AB-external-metric/">HPA è¯†åˆ« external metric</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Loadbalancer</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../kubernetes/loadbalancer/0-local-LoadBalancer-metallb/">Local LoadBalancer metallb</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">ğŸ¶ğŸ¥š ç¢ç¢å¿µ</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Aws</li>
          <li class="breadcrumb-item">Eks</li>
      <li class="breadcrumb-item active">AWS VPC CNI ç½‘ç»œç­–ç•¥</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="aws-vpc-cni">AWS VPC CNI ç½‘ç»œç­–ç•¥</h1>
<p>åœ¨ä½¿ç”¨ EKS çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸€ä¸ªå®‰å…¨çš„ç‚¹å¯ä»¥è€ƒè™‘ -&gt; æˆ‘ä»¬åœ¨ EKs ä¸­éƒ¨ç½²çš„å¾ˆå¤šçš„ç¬¬ä¸‰çš„ä¸œè¥¿ï¼Œå®é™…ä¸Šæˆ‘ä»¬ä½œä¸º DevOpsï¼Œå¹¶ä¸çŸ¥é“å®ƒçš„åº•å±‚æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œè¿™ä¸ªæ—¶å€™å°±å¾ˆéº»çƒ¦ï¼Œå¾ˆæ€•åˆ«äººçš„ä¸œè¥¿å¼•å…¥äº†ä¸€ä¸ªä»€ä¹ˆæ ·çš„ bug å¯¼è‡´å¯ä»¥è¢«é»‘å®¢è¿›å…¥åˆ° Pod é‡Œ ğŸ’¥ æ‰€æœ‰çš„ Pod éƒ½å¯ä»¥åˆ«äººé€šè¿‡ API è®¿é—®åˆ°äº†ï¼è¿™å¯ä¸æ˜¯ä¸€ä¸ªå¥½çš„äº‹æƒ…ï¼Œå®¹æ˜“ä¸¢å·¥ä½œçš„è¯´~ æ±ª~</p>
<p>æ‰€ä»¥å‘¢ï¼Œä»Šå¤©å°±æ¥åˆ†äº«ä¸€ä¸ªè¿˜æŒºæœ‰æ„æ€çš„ä¸œè¥¿(aws vpc cni network policy)</p>
<h2 id="aws-vpc-cni_1">AWS VPC CNI</h2>
<h3 id="aws-vpc-cni_2">ä»€ä¹ˆæ˜¯ <a href="https://github.com/aws/amazon-vpc-cni-k8s">AWS VPC CNI</a> å‘¢ï¼Ÿ</h3>
<p>ç®€å•æ¥è¯´ï¼šå®ƒå°±æ˜¯ Kubernetes é‡Œä¼—å¤š CNI çš„ä¸€ç§å®ç°ã€‚</p>
<p>åªä¸è¿‡å®ƒæ˜¯åŸºäº AWS VPC æ¥å®ç°çš„ï¼Œä¸åƒåˆ«çš„ CNI æ’ä»¶ä¸€æ ·ã€‚åƒ flannelã€calico è¿™ç§éƒ½æ˜¯ä¼šä½¿ç”¨ Kubernetes ä¸­çš„ IP address æ¥ç»™ Pod æ·»åŠ  IPï¼Œè¿™é‡Œæ›´å¤šä½¿ç”¨çš„æ˜¯ Linux æä¾›çš„ network namespaceã€veth-pair æ¥å®ç°è¿™ç§åŠŸèƒ½ï¼Œé  Linux çš„ virtual network æ¥åšã€‚</p>
<p>ä½†æ˜¯ AWS å®ƒå¦è¾Ÿè¹Šå¾„ï¼šå®ƒä¼šç»™æ¯ä¸€ä¸ªè¿è¡Œåœ¨ EC2 ä¸Šçš„ Pod æ”¾ä¸Šä¸€ä¸ª ENI(ä¹Ÿå°±æ˜¯ç½‘å¡) æ¥å®ç°åœ¨ EKS ä¸­ç»™ Pod assign IPï¼Œäºæ˜¯è¿™é‡Œå°±æœ‰ä¸ªå¾ˆå‘çˆ¹çš„é—®é¢˜ï¼Œä¸€ä¸ª EC2 æ‰€èƒ½ attach çš„ ENI æ˜¯æœ‰é™çš„ï¼Œè¿™å°±å¯¼è‡´ CPUã€Memory æœ‰æ—¶å€™è¿˜æ²¡æœ‰è¾¾åˆ° 80%ï¼Œä½†æ˜¯å´å‡ºç° EC2 çš„ ENI å·²ç»ç”¨å°½äº†â€¦â€¦</p>
<p>ä¸è¿‡æœ‰ä¸€ç§è§£å†³åŠæ³•ï¼Œåœ¨ VPC-CNI ä¸Šç§°ä¹‹ä¸º: <a href="https://github.com/aws/amazon-vpc-cni-k8s?tab=readme-ov-file#enable_prefix_delegation-v190">ENABLE_PREFIX_DELEGATION</a>ï¼Œå¼€å¯è¿™ä¸ªåŠŸèƒ½ä¹‹åï¼ŒEC2 ä¼šç»™ ENI åˆ†é…ä¸€ä¸ª /28 çš„ç½‘ç»œå—ï¼Œè¿™æ ·è¿™ä¸ª ENI å°±å¯ä»¥æ§åˆ¶çš„æ˜¯è¿™ä¸ª /28 ä¸‹çš„æ‰€æœ‰ ip è€Œä¸ä»…ä»…æ˜¯å‡ ä¸ªç‹¬ç«‹çš„ ipã€‚</p>
<p><strong>Note: </strong>è¿™é‡Œä¼šå‡ºç° ENI æœ¬æ¥å¯ä»¥æ”¯æŒ 20 ä¸ª ipï¼Œä½†æ˜¯å¼€å¯äº† ENABLE_PREFIX_DELEGATION ä¼šå‡å°‘ä¸€ä¸ª ENI èƒ½ç®¡ç†çš„ ip æ•°é‡ã€‚</p>
<h3 id="aws-vpc-cni-networkpolicy">æ€ä¹ˆä½¿ç”¨ AWS VPC CNI å®ç° NetworkPolicy å‘¢ï¼Ÿ</h3>
<p>åœ¨ kubernetes ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ NetworkPolicy æ¥é™åˆ¶ç½‘ç»œä¹‹é—´çš„è®¿é—®ã€‚</p>
<p>åœ¨æ·»åŠ äº† VPC-CNI addon ä¹‹åï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•çš„é…ç½®ï¼Œé»˜è®¤çš„ <a href="https://github.com/aws/amazon-vpc-cni-k8s?tab=readme-ov-file#network_policy_enforcing_mode-v1171">NETWORK_POLICY_ENFORCING_MODE</a> æ˜¯ standardï¼Œè¿™æ„å‘³ç€é»˜è®¤æ‰€æœ‰çš„ Pod åœ¨ä»»ä½•ä¸€ä¸ª namespace éƒ½å¯ä»¥äº’ç›¸è®¿é—®ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œè¿™å°±å¯¼è‡´å¯èƒ½å‡ºç°å¦‚æœç¬¬ä¸‰æ–¹å¼•å…¥äº† bugï¼Œå°±ä¼šå¯¼è‡´æˆ‘ä»¬çš„æ•°æ®è¢«æ‹–èµ°ã€‚æ‰€ä»¥å¦‚æœæƒ³è¦é™åˆ¶è®¿é—®ï¼Œéœ€è¦æŠŠ <code>NETWORK_POLICY_ENFORCING_MODE</code> å€¼è®¾ç½®ä¸º: strictï¼Œè¿™æ„å‘³ç€ï¼Œä»»ä½•ä¸€ä¸ª Pod åœ¨æ²¡æœ‰é…ç½®ä»»ä½•çš„ NetworkPolicy éƒ½ä¸èƒ½äº’ç›¸è®¿é—®ã€‚</p>
<p><strong>æ³¨æ„: ç”šè‡³åŒä¸€ä¸ª namespace çš„ pod éƒ½ä¸èƒ½äº’ç›¸è®¿é—® ğŸ˜‰ (æ˜¯ä¸æ˜¯éå¸¸ä¸¥æ ¼)</strong></p>
<p>é™¤äº†éœ€è¦ä¿®æ”¹ <code>NETWORK_POLICY_ENFORCING_MODE</code> å€¼ä¸º: strictï¼Œè¿˜éœ€è¦å¼€å¯ä¸€ä¸ª VPC-CNI å†…éƒ¨çš„ controller æ‰å¯ä»¥ã€‚å¯ä»¥é€šè¿‡åœ¨ VPC-CNI addon é…ç½®ç•Œé¢ -&gt; Advanced configuration ä¸­æ·»åŠ  <code>{"enableNetworkPolicy":"true"}</code> æ‰å¯ä»¥ï¼Œè¿™æ ·ä¼šä¿®æ”¹ kube-system namespace ä¸‹çš„ amazon-vpc-cni configmap</p>
<pre><code class="language-yaml">apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/instance: aws-vpc-cni
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: aws-node
    app.kubernetes.io/version: v1.18.1
    helm.sh/chart: aws-vpc-cni-1.18.1
    k8s-app: aws-node
  name: amazon-vpc-cni
  namespace: kube-system
data:
  branch-eni-cooldown: &quot;60&quot;
  enable-network-policy-controller: &quot;true&quot; # è¿™ä¸ªå€¼å˜ä¸º true
  enable-windows-ipam: &quot;false&quot;
  enable-windows-prefix-delegation: &quot;false&quot;
  minimum-ip-target: &quot;3&quot;
  warm-ip-target: &quot;1&quot;
  warm-prefix-target: &quot;0&quot;
</code></pre>
<p>ä¹‹åå°±å¯ä»¥åˆ›å»º NetworkPolicy æ¥é™åˆ¶ä¸åŒ namespace ä¹‹é—´çš„è®¿é—®äº†ã€‚</p>
<p><strong>æ³¨æ„ï¼š</strong> 
1. é€šè¿‡ fargate å¯åŠ¨çš„ pod ä¸ä¼šæ”¶åˆ° NetworkPolicy çš„å½±å“ https://docs.aws.amazon.com/eks/latest/userguide/cni-network-policy.html
2. å¿…é¡»ä¸¤è¾¹éƒ½é…ç½®æ‰å¯ä»¥è®¿é—®é€šï¼Œåœ¨ä¸€ä¸ª namespace å…è®¸ egress(å‡º)ï¼Œåœ¨å¦ä¸€ä¸ª namespace å…è®¸ ingress(è¿›)
3. NetworkPolicy éƒ½åªæ˜¯é’ˆå¯¹æ–°åˆ›å»ºçš„ Podï¼Œæ‰€ä»¥æ¯æ¬¡ä¿®æ”¹äº† NetworkPolicy æœ€å¥½éƒ½æ˜¯ç›´æ¥é‡å¯ä¸€èµ·å—åˆ°å½±å“çš„ Pod</p>
<h3 id="example">Example</h3>
<ul>
<li>å…è®¸ç›¸åŒ namespace äº’ç›¸è®¿é—®</li>
</ul>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: np
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector: {}
  egress:
    - to:
        - podSelector: {}
</code></pre>
<ul>
<li>å…è®¸è®¿é—®å¤–ç½‘ï¼Œä½†æ˜¯ä½¿ç”¨ pod ip è¿˜æ˜¯ä¸èƒ½è®¿é—®çš„</li>
</ul>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: np
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
</code></pre>
<ul>
<li>å…è®¸è®¿é—® coredns æ¥è§£æ svc</li>
</ul>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: np
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - port: 53
          protocol: UDP
</code></pre>
<ul>
<li>å…è®¸ä¸€ä¸ª namespace çš„æ‰€æœ‰ pod è®¿é—®å½“å‰ namespace</li>
</ul>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: np
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector: {}
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: demo
</code></pre>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªéå¸¸å¥½ç”¨çš„ç½‘ç«™ï¼Œå¯ä»¥å‚»ç“œå¼é…ç½® NetworkPolicy: https://editor.networkpolicy.io ğŸ˜‰</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../.." class="btn btn-neutral float-left" title="Hello World"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../iam/0-%E8%AE%A4%E8%AF%86%20sso/" class="btn btn-neutral float-right" title="è®¤è¯† AWS SSO">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../../.." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../iam/0-%E8%AE%A4%E8%AF%86%20sso/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
